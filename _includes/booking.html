<!-- Start of Chalet Le Renard Booking Section -->
<section id="booking" style="padding: 20px; background-color: #f9f9f9;">
  <div style="max-width: 1200px; margin: 0 auto;">
    <h2 style="font-family: Arial, sans-serif; font-size: 24px; margin-bottom: 20px;">Réservez votre séjour au Chalet Le Renard</h2>
    <div style="display: flex; flex-wrap: wrap; gap: 20px; background-color: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">
      <div style="flex: 1 1 300px;">
        <label for="checkin" style="display: block; margin-bottom: 5px; font-weight: bold;">Date d'arrivée</label>
        <input type="text" id="checkin" placeholder="Choisissez une date" readonly style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px;">
      </div>
      <div style="flex: 1 1 300px;">
        <label for="checkout" style="display: block; margin-bottom: 5px; font-weight: bold;">Date de départ</label>
        <input type="text" id="checkout" placeholder="Choisissez une date" readonly style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px;">
      </div>
      <div style="flex: 1 1 300px;">
        <label for="guests" style="display: block; margin-bottom: 5px; font-weight: bold;">Nombre de personnes</label>
        <select id="guests" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px;">
          <option value="1">1 personne</option>
          <option value="2">2 personnes</option>
          <option value="3">3 personnes</option>
          <option value="4">4 personnes</option>
          <option value="5">5 personnes</option>
          <option value="6">6 personnes</option>
        </select>
      </div>
      <div style="flex: 1 1 300px; align-self: flex-end;">
        <button id="searchButton" disabled style="width: 100%; padding: 10px; background-color: #ccc; color: #fff; border: none; border-radius: 5px; cursor: not-allowed; transition: background-color 0.3s;">Réserver</button>
      </div>
    </div>
  </div>
</section>

<!-- Custom CSS to style disabled dates -->
<style>
  .flatpickr-day.flatpickr-disabled {
    text-decoration: line-through;
    background-color: #f8d7da;
    border: 1px solid #f5c6cb;
  }
</style>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<!-- Include French locale for flatpickr -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/fr.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://js.stripe.com/v3/"></script>
<script>
  const stripe = Stripe("pk_live_51OxskHLiPCVDYAuQlkZnBtv5TfdLNUlUU4AvFIdNKZ25Ogc7cj25R2oIwyKHOVl9DM5Zb11GkA32IH4LagpoKfCr00yR2kV7Wl");
  const searchButton = document.getElementById("searchButton");
  let latestJsonData = [];
  let unavailableDates = [];
  // Global variable to store the current total pre-tax price for use during checkout
  let currentTotalPreTax = 0;

  // Fetch JSON data for pricing and minimum stay conditions
  fetch("https://chaletlerenard.github.io/data/latest.json")
    .then(response => response.json())
    .then(data => {
      latestJsonData = data;
      console.log("JSON data loaded successfully");
    })
    .catch(error => console.error("Error loading JSON data: ", error));

  // Use thingproxy.freeboard.io proxy to fetch the Airbnb ICS file and bypass CORS restrictions
  const icsUrl = "https://www.airbnb.ca/calendar/ical/1007176969711247110.ics?s=bd2f78f8639ccafc0dc156caff1d26d2";
  const proxyUrl = "https://thingproxy.freeboard.io/fetch/" + icsUrl;
  fetch(proxyUrl)
    .then(response => response.text())
    .then(data => {
      const icalData = data;
      unavailableDates = parseICal(icalData);
      console.log("Unavailable dates:", unavailableDates);
      initDatePickers();
    })
    .catch(error => {
      console.error("Error fetching ICS data: ", error);
      // Initialize date pickers without unavailable dates if the fetch fails
      initDatePickers();
    });

  // Function to parse the ICS data and extract unavailable dates
  function parseICal(data) {
    const lines = data.split(/\r?\n/);
    const unavailable = [];
    lines.forEach(line => {
      if (line.startsWith("DTSTART")) {
        const date = line.split(":")[1];
        if (date) {
          // Format date as YYYY-MM-DD
          const formattedDate = date.slice(0, 4) + "-" + date.slice(4, 6) + "-" + date.slice(6, 8);
          unavailable.push(formattedDate);
        }
      }
    });
    return unavailable;
  }

  // Initialize the flatpickr date pickers with French locale and custom disabled styles
  function initDatePickers() {
    const disabledDates = [...unavailableDates];

    flatpickr("#checkin", {
      locale: "fr",
      dateFormat: "Y-m-d",
      disable: [
        date => date.getDay() === 6,  // Disable Saturdays
        ...disabledDates
      ],
      onChange: checkDates
    });

    flatpickr("#checkout", {
      locale: "fr",
      dateFormat: "Y-m-d",
      disable: [
        date => date.getDay() === 6,  // Disable Saturdays
        ...disabledDates
      ],
      onChange: checkDates
    });
  }

  // Check the selected dates against availability and pricing conditions
  function checkDates() {
    const checkin = document.getElementById("checkin").value;
    const checkout = document.getElementById("checkout").value;
    const guests = document.getElementById("guests").value;

    if (!checkin || !checkout) {
      searchButton.disabled = true;
      searchButton.classList.remove("active");
      searchButton.style.backgroundColor = "#ccc";
      searchButton.style.cursor = "not-allowed";
      searchButton.innerText = "Réserver";
      return;
    }

    const nights = dateDiff(checkin, checkout);
    const stayDates = getStayDates(checkin, checkout);
    // Filter the JSON data for the selected stay dates that are available
    const stayPrices = latestJsonData.filter(day => stayDates.includes(day.Date) && day.Available === "True");

    if (stayPrices.length !== nights) {
      searchButton.disabled = true;
      searchButton.classList.remove("active");
      searchButton.style.backgroundColor = "#ccc";
      searchButton.style.cursor = "not-allowed";
      searchButton.innerText = "Dates non disponibles";
      return;
    }

    // Check for minimum stay requirement from the JSON data
    const maxMinStay = Math.max(...stayPrices.map(day => parseInt(day["Min Stay"])));
    if (nights < maxMinStay) {
      searchButton.disabled = true;
      searchButton.classList.remove("active");
      searchButton.style.backgroundColor = "#ccc";
      searchButton.style.cursor = "not-allowed";
      searchButton.innerText = `Minimum ${maxMinStay} nuits pour ces dates`;
      return;
    }

    // Calculate the total nightly rate
    const totalNightlyRate = stayPrices.reduce((total, day) => total + parseInt(day["Final Price"]), 0);
    const cleaningFee = nights >= 3 ? 150 : 140;
    // Apply extra 20 dollars per night if there is a 6th guest
    const sixthGuestFee = parseInt(guests) === 6 ? 20 * nights : 0;
    const totalPreTax = totalNightlyRate + cleaningFee + sixthGuestFee;
    // Store in a global variable for use in checkout
    currentTotalPreTax = totalPreTax;

    searchButton.disabled = false;
    searchButton.classList.add("active");
    searchButton.style.backgroundColor = "#d2691e";
    searchButton.style.cursor = "pointer";
    searchButton.innerText = `Réserver pour ${totalPreTax.toFixed(2)} $`;
  }

  // Recalculate pricing when the number of guests changes
  document.getElementById("guests").addEventListener("change", checkDates);

  // Attach the click event handler to create a Stripe checkout session
  searchButton.addEventListener("click", () => {
    const checkin = document.getElementById("checkin").value;
    const checkout = document.getElementById("checkout").value;
    const guests = document.getElementById("guests").value;
    fetch("https://chalet-checkout-backend.onrender.com/create-checkout-session", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        amount: currentTotalPreTax,
        guests: guests,
        dates: `${checkin} - ${checkout}`
      })
    })
      .then(response => response.json())
      .then(session => stripe.redirectToCheckout({ sessionId: session.id }))
      .catch(error => {
        console.error("Error during checkout:", error);
        alert("Une erreur est survenue. Veuillez réessayer.");
      });
  });

  // Helper function to calculate the difference in days between two dates
  function dateDiff(start, end) {
    const startDate = new Date(start);
    const endDate = new Date(end);
    const diffTime = Math.abs(endDate - startDate);
    return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  }

  // Helper function to get all dates in the stay period
  function getStayDates(start, end) {
    const dates = [];
    let current = new Date(start);
    const endDate = new Date(end);
    while (current < endDate) {
      dates.push(current.toISOString().split("T")[0]);
      current.setDate(current.getDate() + 1);
    }
    return dates;
  }
</script>
<!-- End of Chalet Le Renard Booking Section -->
