<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Réservation - Chalet Le Renard</title>

  <link rel="stylesheet" href="{{ '/assets/css/styles.css' | relative_url }}">
  <link rel="stylesheet" href="https://npmcdn.com/flatpickr/dist/flatpickr.min.css">
</head>
<body>

<section id="booking">
  <h2>Réservez votre séjour au Chalet Le Renard</h2>

  <!-- Formulaire de réservation -->
  <div>
    <label>Date d'arrivée</label>
    <input type="text" id="checkin">

    <label>Date de départ</label>
    <input type="text" id="checkout">

    <label>Nombre de personnes</label>
    <select id="guests">
      <option value="1">1 personne</option>
      <option value="2">2 personnes</option>
      <option value="3">3 personnes</option>
      <option value="4">4 personnes</option>
      <option value="5">5 personnes</option>
      <option value="6">6 personnes</option>
    </select>

    <label>J'amènerai mon chien</label>
    <input type="checkbox" id="dog">

    <button id="searchButton" disabled>Réserver</button>
  </div>
</section>

<script src="https://npmcdn.com/flatpickr/dist/flatpickr.min.js"></script>
<script src="https://npmcdn.com/flatpickr/dist/l10n/fr.js"></script>

<script>
  const searchButton = document.getElementById("searchButton");

  let latestJsonData = [];
  let currentTotalPreTax = 0;

  // Exemple données JSON simulées
  latestJsonData = [
    { Date: "2025-05-01", Available: "True", "Final Price": "300", "Min Stay": "2" },
    { Date: "2025-05-02", Available: "True", "Final Price": "300", "Min Stay": "2" }
  ];

  flatpickr("#checkin", {
    locale: flatpickr.l10ns.fr,
    dateFormat: "Y-m-d",
    onChange: checkDates
  });

  flatpickr("#checkout", {
    locale: flatpickr.l10ns.fr,
    dateFormat: "Y-m-d",
    onChange: checkDates
  });

  function checkDates() {
    const checkin = document.getElementById("checkin").value;
    const checkout = document.getElementById("checkout").value;
    const guests = parseInt(document.getElementById("guests").value);
    const dogChecked = document.getElementById("dog").checked;

    if (!checkin || !checkout) {
      searchButton.disabled = true;
      return;
    }

    const nights = dateDiff(checkin, checkout);
    const stayDates = getStayDates(checkin, checkout);

    const stayPrices = latestJsonData.filter(day => stayDates.includes(day.Date) && day.Available === "True");

    if (stayPrices.length !== nights) {
      searchButton.disabled = true;
      return;
    }

    const totalNightlyRate = stayPrices.reduce((total, day) => total + parseInt(day["Final Price"]), 0);
    const cleaningFee = nights >= 3 ? 150 : 140;
    const sixthGuestFee = guests === 6 ? 20 * nights : 0;
    const dogFee = dogChecked ? 75 : 0;

    currentTotalPreTax = totalNightlyRate + cleaningFee + sixthGuestFee + dogFee;

    searchButton.disabled = false;
    searchButton.innerText = `Réserver pour ${currentTotalPreTax.toFixed(2)} $`;
  }

  searchButton.addEventListener("click", () => {
    const bookingDetails = {
      checkin: document.getElementById("checkin").value,
      checkout: document.getElementById("checkout").value,
      guests: parseInt(document.getElementById("guests").value),
      hasDog: document.getElementById("dog").checked,
      currentTotalPreTax: currentTotalPreTax
    };

    console.log("Données envoyées sur la page 2 :", bookingDetails);

    localStorage.setItem("bookingData", JSON.stringify(bookingDetails));
    window.location.href = "contact-details.html";
  });

  function dateDiff(start, end) {
    const startDate = new Date(start);
    const endDate = new Date(end);
    const diffTime = endDate - startDate;
    return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  }

  function getStayDates(start, end) {
    const dates = [];
    let current = new Date(start);
    const endDate = new Date(end);
    while (current < endDate) {
      dates.push(current.toISOString().split("T")[0]);
      current.setDate(current.getDate() + 1);
    }
    return dates;
  }
</script>

</body>
</html>
