<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Airbnb Calendar with Pricing</title>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.4/main.min.css" rel="stylesheet">
    <style>
      body {
          font-family: Arial, sans-serif;
          margin: 40px;
          background-color: #f5f5f5;
      }
      #calendar {
          max-width: 900px;
          margin: 0 auto;
          background: white;
          padding: 20px;
          border-radius: 8px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }
      #pricing {
          max-width: 900px;
          margin: 20px auto;
          padding: 10px;
          text-align: center;
          background: #fff;
          border-radius: 8px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
          font-size: 18px;
      }
    </style>
</head>
<body>
  <div id="calendar"></div>
  <div id="pricing">Select a date range to see pricing</div>

  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.4/main.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ical.js/1.4.0/ical.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function() {
        const icalUrl = "https://www.airbnb.com/calendar/ical/your_calendar.ics";
        
        async function fetchICal() {
            try {
                const response = await fetch(icalUrl);
                if (!response.ok) {
                    throw new Error("Network response was not ok");
                }
                const icalText = await response.text();
                const jcalData = ICAL.parse(icalText);
                const comp = new ICAL.Component(jcalData);
                const events = comp.getAllSubcomponents("vevent");
                let fullCalendarEvents = [];

                events.forEach(event => {
                    let vevent = new ICAL.Event(event);
                    let start = vevent.startDate.toJSDate();
                    let end = vevent.endDate.toJSDate();

                    // Airbnb iCal DTEND is exclusive, subtract one day for actual last unavailable night
                    let adjustedEnd = new Date(end);
                    adjustedEnd.setDate(adjustedEnd.getDate() - 1);

                    let currentDate = new Date(start);
                    while (currentDate <= adjustedEnd) {
                        let day = new Date(currentDate);
                        fullCalendarEvents.push({
                            title: "Unavailable",
                            start: day,
                            end: day,
                            display: "background",
                            allDay: true,
                            backgroundColor: "#d3d3d3" // greyed out
                        });
                        currentDate.setDate(currentDate.getDate() + 1);
                    }
                });

                return fullCalendarEvents;
            } catch (error) {
                console.error("Error fetching or parsing iCal feed:", error);
                return [];
            }
        }
        
        async function initCalendar() {
            let events = await fetchICal();
            let calendarEl = document.getElementById("calendar");
            let calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: "dayGridMonth",
                selectable: true,
                selectOverlap: false, // prevents selecting booked dates
                events: events,
                select: function(info) {
                    let selectedStart = info.start;
                    let selectedEnd = new Date(info.end);
                    selectedEnd.setDate(selectedEnd.getDate() - 1); // Make end inclusive

                    let selectedDays = (selectedEnd - selectedStart) / (1000 * 60 * 60 * 24) + 1;
                    let basePrice = 100;
                    let totalPrice = selectedDays * basePrice;

                    let booked = events.some(event => {
                        if (event.display !== "background") {
                            return false; // skip non-background events (precaution)
                        }
                        let eventDate = new Date(event.start);
                        return eventDate >= selectedStart && eventDate <= selectedEnd;
                    });

                    let pricingEl = document.getElementById("pricing");
                    if (booked) {
                        pricingEl.textContent = "Selected dates include unavailable days.";
                    } else {
                        pricingEl.textContent = "Total price for " + selectedDays + " days is $" + totalPrice.toFixed(2);
                    }
                },
                unselect: function() {
                    document.getElementById("pricing").textContent = "Select a date range to see pricing";
                }
            });
            
            calendar.render();
        }
        
        initCalendar();
    });
  </script>
</body>
</html>
